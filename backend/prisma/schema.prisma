generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum UserRole {
  USER
  SUPERADMIN
}

enum SubscriptionStatus {
  active
  inactive
  expired
}

enum PaymentType {
  renta
  arrear_payment
  other
}

enum ArrearStatus {
  pending
  paid
}

// --- MODELOS ---

model User {
  id                String             @id @default(uuid())
  username          String             @unique
  email             String             @unique
  password          String
  role              UserRole           @default(USER)
  isConfirmed       Boolean            @default(false)
  confirmationToken String?
  resetToken        String?
  lastActivity      DateTime?
  createdAt         DateTime           @default(now())
  
  // Relaciones (Aislamiento de datos por UserID como TenantID)
  vehicles          Vehicle[]
  drivers           Driver[]
  payments          Payment[]
  expenses          Expense[]
  arrears           Arrear[]
  subscriptions     SubscriptionKey[]

  @@index([email])
  @@index([username])
}

model SubscriptionKey {
  id        String             @id @default(uuid())
  userId    String?
  user      User?              @relation(fields: [userId], references: [id])
  plan      String             // free_trial, basico, pro, enterprise
  price     Decimal            @db.Decimal(12, 2)
  months    Int                @default(1)
  startDate DateTime?
  dueDate   DateTime?
  status    SubscriptionStatus @default(active)

  @@index([userId, status])
}

model Driver {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName    String
  lastName     String
  email        String?
  phone        String?
  idNumber     String
  licensePhoto String?
  idPhoto      String?

  vehicleId    String?   @unique
  vehicle      Vehicle?  @relation(fields: [vehicleId], references: [id])
  payments     Payment[]
  arrears      Arrear[]

  @@index([userId, idNumber])
}

model Vehicle {
  id               String    @id @default(uuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  year             Int
  licensePlate     String
  model            String
  color            String
  purchaseDate     DateTime?
  insurance        String?
  insuranceNumber  String?
  soatExpiration   DateTime?
  techExpiration   DateTime?
  rentaValue       Decimal   @db.Decimal(12, 2)
  driver           Driver?

  // PostgreSQL permite arreglos nativos de Strings para fotos
  photos           String[]

  payments         Payment[]
  expenses         Expense[]
  arrears          Arrear[]

  @@unique([userId, licensePlate])
}

model Payment {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Decimal     @db.Decimal(12, 2)
  date      DateTime    @default(now())
  
  driverId  String
  driver    Driver      @relation(fields: [driverId], references: [id])
  
  vehicleId String
  vehicle   Vehicle     @relation(fields: [vehicleId], references: [id])
  
  type      PaymentType @default(renta)
  arrearId  String?
  
  @@index([userId, date])
  @@index([driverId, vehicleId])
}

model Arrear {
  id              String       @id @default(uuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  amountOwed      Decimal      @db.Decimal(12, 2)
  status          ArrearStatus @default(pending)
  
  driverId        String
  driver          Driver       @relation(fields: [driverId], references: [id])
  
  vehicleId       String
  vehicle         Vehicle      @relation(fields: [vehicleId], references: [id])
  
  dueDate         DateTime
  originPaymentId String?      // ID del pago que gener√≥ esta mora por saldo incompleto

  @@index([userId, status])
  @@index([driverId])
}

model Expense {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  description String
  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime @default(now())
  
  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id])

  @@index([userId, date])
}